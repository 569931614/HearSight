services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: hearsight-backend
    restart: unless-stopped
    # 使用本地 PostgreSQL，不需要依赖 Docker 中的 postgres 服务
    # depends_on:
    #   postgres:
    #     condition: service_healthy
    # 生产环境使用命名卷持久化数据（由 Docker 管理）
    volumes:
      - ./app_datas:/app/app_datas
      # 注意：将整仓库绑定到容器根目录（./:/app:ro）会导致在只读 bind-mount 上创建子挂载点失败
      # 如果你需要在开发时热加载代码，可把下面这一行取消注释并调整为非只读（/:/app:rw），或改为把代码挂到其它路径
      # - ./:/app:ro
    ports:
      - "${BACKEND_PORT:-9999}:8000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - PORT=8000
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-hearsight}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-hearsight_pass}
      - POSTGRES_DB=${POSTGRES_DB:-hearsight}
      - MS_MODEL_CACHE=/app/app_datas/model_cache
      - TORCH_HOME=/app/app_datas/torch_cache
      - HF_HOME=/app/app_datas/transformers_cache
      - XDG_CACHE_HOME=/app/app_datas/xdg_cache
      - BACKEND_PORT=${BACKEND_PORT:-9999}
      - FRONTEND_HOST=${FRONTEND_HOST:-localhost}
      - FRONTEND_PORT=${FRONTEND_PORT:-10000}
      # OpenAI / Chat API 配置
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.siliconflow.cn/v1}
      - OPENAI_CHAT_MODEL=${OPENAI_CHAT_MODEL:-deepseek-ai/DeepSeek-V3}
      - CHAT_MAX_WINDOWS=${CHAT_MAX_WINDOWS:-1000000}
      # Bilibili 配置
      - BILIBILI_SESSDATA=${BILIBILI_SESSDATA}
      # Qdrant 配置（使用 pyvideotrans 的 video_qdrant 容器）
      - QDRANT_URL=${QDRANT_URL:-http://video_qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      # RAG 配置
      - RAG_ENABLED=${RAG_ENABLED:-true}
      - RAG_TOP_K=${RAG_TOP_K:-5}
      - RAG_SIMILARITY_THRESHOLD=${RAG_SIMILARITY_THRESHOLD:-0.7}
      - RAG_INCLUDE_SUMMARIES=${RAG_INCLUDE_SUMMARIES:-true}
    # GPU 配置已注释（本地环境无 GPU）
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: hearsight-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-10000}:80"
    environment:
      - PORT=80
      - BACKEND_HOST=${BACKEND_HOST:-backend}
      - BACKEND_PORT=${BACKEND_PORT:-8000}
      - USE_DOCKER=1


  # 使用本地 PostgreSQL，不再需要 Docker 中的 postgres 服务
  # postgres:
  #   image: postgres:17
  #   container_name: hearsight-postgres
  #   restart: unless-stopped
  #   ports:
  #     - "${POSTGRES_PORT:-5432}:5432"
  #   environment:
  #     - POSTGRES_USER=${POSTGRES_USER:-hearsight}
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-hearsight_pass}
  #     - POSTGRES_DB=${POSTGRES_DB:-hearsight}
  #   volumes:
  #     - ./app_datas/postgres:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-hearsight} -d ${POSTGRES_DB:-hearsight}"]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5

  # qdrant:
  #   # 注释：HearSight 与 pyvideotrans 共享 Qdrant 实例
  #   # 使用 pyvideotrans 的 video_qdrant 容器（端口 3307）
  #   image: qdrant/qdrant:latest
  #   container_name: hearsight-qdrant
  #   restart: unless-stopped
  #   ports:
  #     - "${QDRANT_HTTP_PORT:-3307}:6333"  # HTTP API
  #     - "${QDRANT_GRPC_PORT:-6334}:6334"  # gRPC API
  #   volumes:
  #     - ./app_datas/qdrant_storage:/qdrant/storage
  #   environment:
  #     - QDRANT__SERVICE__GRPC_PORT=6334




